
#' @title Insert dependencies to track usage of a Shiny app
#'
#' @description If used in \code{ui} of an application, this will create new \code{input}s available in the server.
#'
#' @note The following \code{input}s will be accessible in the server:
#'
#'   - \strong{.shinylogs_lastinput} : last \code{input} used by the user
#'
#'   - \strong{.shinylogs_input} : all \code{input}s send from the browser to the server
#'
#'   - \strong{.shinylogs_error} : all errors generated by \code{output}s elements
#'
#'   - \strong{.shinylogs_output} : all \code{output}s generated from the server
#'
#' @export
#'
#' @importFrom htmltools attachDependencies tags
tracking_ui <- function() {
  attachDependencies(
    x = tags$div(),
    value = list(
      lowdb_dependencies(),
      shinylogs_dependencies()
    )
  )
}


#' @importFrom jsonlite fromJSON
parse_log <- function(x, shinysession, name) {
  lapply(
    X = x,
    FUN = fromJSON
  )
}


#' @title Track usage of a Shiny app
#'
#' @description Used in Shiny \code{server} it will save everything that happens in a Shiny app.
#'
#' @param storage_mode Storage mode to use : \code{\link{store_json}}
#' @param exclude_users Character vectors of user for whom it is not necessary to save the log.
#' @param session The shiny session.
#'
#' @export
#'
#' @importFrom shiny getDefaultReactiveDomain insertUI onSessionEnded isolate
#' @importFrom nanotime nanotime
#' @importFrom bit64 as.integer64
#' @importFrom digest digest
track_usage <- function(storage_mode = store_json(),
                        exclude_users = NULL,
                        session = getDefaultReactiveDomain()) {
  stopifnot(inherits(storage_mode, "shinylogs.storage_mode"))
  insertUI(
    selector = "body",
    ui = tracking_ui(),
    immediate = TRUE,
    session = session
  )
  app_name <- basename(getwd())
  if (is.null(session$user)) {
    user <- getOption("shinylogs.default_user", default = "")
  } else {
    user <- session$user
  }
  timestamp <- Sys.time()
  init_log <- data.frame(
    app = app_name,
    user = user,
    timestamp_connected = as.numeric(timestamp),
    stringsAsFactors = FALSE
  )
  storage_mode$appname <- app_name
  storage_mode$timestamp <- format(as.integer64(nanotime(timestamp)), scientific = FALSE)
  onSessionEnded(
    fun = function() {
      init_log$timestamp_disconnected <- as.numeric(Sys.time())
      init_log$sessionid <- digest::digest(storage_mode$timestamp)
      logs <- c(isolate(session$input$.shinylogs_input),
                isolate(session$input$.shinylogs_error),
                isolate(session$input$.shinylogs_output))
      logs$user <- init_log
      if (isTRUE(!user %in% exclude_users)) {
        write_logs(storage_mode, logs)
      }
    },
    session = session
  )
}

